name: Run LRP Report Scripts Daily

on:
  schedule:
    - cron: "45 20 * * *"
    - cron: "0 21 * * *"
    - cron: "30 21 * * *"
  workflow_dispatch:

jobs:
  run-scripts:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            requests \
            beautifulsoup4 \
            google-auth \
            google-auth-oauthlib \
            google-api-python-client \
            gspread \
            pandas \
            openpyxl

      - name: Create credentials.json from Secret
        run: |
          echo "${{ secrets.GOOGLE_OAUTH_CREDENTIALS_B64 }}" | base64 --decode > credentials.json

      - name: Create token.json from Secret (if present)
        env:
          GOOGLE_OAUTH_TOKEN_B64: ${{ secrets.GOOGLE_OAUTH_TOKEN_B64 }}
        run: |
          if [ -n "$GOOGLE_OAUTH_TOKEN_B64" ]; then
            echo "$GOOGLE_OAUTH_TOKEN_B64" | base64 --decode > token.json
            echo "token.json created"
          else
            echo "No token secret provided — continuing"
          fi

      - name: Run LRP Scripts
        env:
          GOOGLE_OAUTH_CREDENTIALS_B64: ${{ secrets.GOOGLE_OAUTH_CREDENTIALS_B64 }}
        run: |
          set -e
          python Unborn.py
          python Steers1.py
          python Steers2.py
          python Heifers1.py
          python Heifers2.py
          python MDY.py

  retry-run:
    needs: run-scripts        # fix job name
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            requests \
            beautifulsoup4 \
            google-auth \
            google-auth-oauthlib \
            google-api-python-client \
            gspread \
            pandas \
            openpyxl

      - name: Restore credentials
        env:
          GOOGLE_OAUTH_CREDENTIALS_B64: ${{ secrets.GOOGLE_OAUTH_CREDENTIALS_B64 }}
          GOOGLE_OAUTH_TOKEN_B64: ${{ secrets.GOOGLE_OAUTH_TOKEN_B64 }}
        run: |
          echo "$GOOGLE_OAUTH_CREDENTIALS_B64" | base64 --decode > credentials.json
          if [ -n "$GOOGLE_OAUTH_TOKEN_B64" ]; then
            echo "$GOOGLE_OAUTH_TOKEN_B64" | base64 --decode > token.json
          fi

      - name: Retry scripts (up to 5 times)
        env:
          GOOGLE_OAUTH_CREDENTIALS_B64: ${{ secrets.GOOGLE_OAUTH_CREDENTIALS_B64 }}
        run: |
          MAX_ATTEMPTS=5
          ATTEMPT=1

          until [ $ATTEMPT -gt $MAX_ATTEMPTS ]
          do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            python Unborn.py && \
            python Steers1.py && \
            python Steers2.py && \
            python Heifers1.py && \
            python Heifers2.py && \
            python MDY.py && break

            echo "Attempt $ATTEMPT failed — retrying in 30 minutes"
            sleep 1800
            ATTEMPT=$((ATTEMPT+1))
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "All retry attempts failed"
            exit 1
          fi
